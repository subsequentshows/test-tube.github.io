<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Water pouring</title>

  <link rel="stylesheet" href="./css/index.css">
</head>

<body>
  <p>Level 99</p>
  <div class="content-container">

    <div class="row">

      <div class="col">
        <div class="bottle" style="background-image: url(./image/bottles/bottle-1.png)">
          <div id="banner">
            <div class="pour"></div>
            <div class="fills">
              <svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px"
                y="0px" width="108px" height="300px" viewBox="0 0 150 150" enable-background="new 0 0 150 150"
                xml:space="preserve">
                <path fill="#04ACFF" id="waveShape" d="M300,300V2.5c0,0-0.6-0.1-1.1-0.1c0,0-25.5-2.3-40.5-2.4c-15,0-40.6,2.4-40.6,2.4
  c-12.3,1.1-30.3,1.8-31.9,1.9c-2-0.1-19.7-0.8-32-1.9c0,0-25.8-2.3-40.8-2.4c-15,0-40.8,2.4-40.8,2.4c-12.3,1.1-30.4,1.8-32,1.9
  c-2-0.1-20-0.8-32.2-1.9c0,0-3.1-0.3-8.1-0.7V300H300z" />
              </svg>
            </div>
          </div>
        </div>
      </div>

      <div class="col">
        <div class="bottle" style="background-image: url(./image/bottles/bottle-2.png)">
          <div id="banner">
            <div class="pour"></div>
            <div class="fills">
              <svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px"
                y="0px" width="300px" height="300px" viewBox="0 0 300 300" enable-background="new 0 0 300 300"
                xml:space="preserve">
                <path fill="#04ACFF" id="waveShape" d="M300,300V2.5c0,0-0.6-0.1-1.1-0.1c0,0-25.5-2.3-40.5-2.4c-15,0-40.6,2.4-40.6,2.4
  c-12.3,1.1-30.3,1.8-31.9,1.9c-2-0.1-19.7-0.8-32-1.9c0,0-25.8-2.3-40.8-2.4c-15,0-40.8,2.4-40.8,2.4c-12.3,1.1-30.4,1.8-32,1.9
  c-2-0.1-20-0.8-32.2-1.9c0,0-3.1-0.3-8.1-0.7V300H300z" />
              </svg>
            </div>
          </div>
        </div>
      </div>

      <div class="col">
        <div class="bottle" style="background-image: url(./image/bottles/bottle-3.png)">
          <div id="banner">
            <div class="pour"></div>
            <div class="fills">
              <svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px"
                y="0px" width="300px" height="300px" viewBox="0 0 300 300" enable-background="new 0 0 300 300"
                xml:space="preserve">
                <path fill="#04ACFF" id="waveShape" d="M300,300V2.5c0,0-0.6-0.1-1.1-0.1c0,0-25.5-2.3-40.5-2.4c-15,0-40.6,2.4-40.6,2.4
  c-12.3,1.1-30.3,1.8-31.9,1.9c-2-0.1-19.7-0.8-32-1.9c0,0-25.8-2.3-40.8-2.4c-15,0-40.8,2.4-40.8,2.4c-12.3,1.1-30.4,1.8-32,1.9
  c-2-0.1-20-0.8-32.2-1.9c0,0-3.1-0.3-8.1-0.7V300H300z" />
              </svg>
            </div>
          </div>
        </div>
      </div>

      <div class="col">
        <div id="banner">
          <div class="pour"></div>
          <div class="fills">
            <svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px"
              y="0px" width="300px" height="300px" viewBox="0 0 300 300" enable-background="new 0 0 300 300"
              xml:space="preserve">
              <path fill="#04ACFF" id="waveShape" d="M300,300V2.5c0,0-0.6-0.1-1.1-0.1c0,0-25.5-2.3-40.5-2.4c-15,0-40.6,2.4-40.6,2.4
  c-12.3,1.1-30.3,1.8-31.9,1.9c-2-0.1-19.7-0.8-32-1.9c0,0-25.8-2.3-40.8-2.4c-15,0-40.8,2.4-40.8,2.4c-12.3,1.1-30.4,1.8-32,1.9
  c-2-0.1-20-0.8-32.2-1.9c0,0-3.1-0.3-8.1-0.7V300H300z" />
            </svg>
          </div>
        </div>
      </div>

      <div class="col">
        <div id="banner">
          <div class="pour"></div>
          <div class="fills ">
            <svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px"
              y="0px" width="300px" height="300px" viewBox="0 0 300 300" enable-background="new 0 0 300 300"
              xml:space="preserve">
              <path fill="#04ACFF" id="waveShape" d="M300,300V2.5c0,0-0.6-0.1-1.1-0.1c0,0-25.5-2.3-40.5-2.4c-15,0-40.6,2.4-40.6,2.4
  c-12.3,1.1-30.3,1.8-31.9,1.9c-2-0.1-19.7-0.8-32-1.9c0,0-25.8-2.3-40.8-2.4c-15,0-40.8,2.4-40.8,2.4c-12.3,1.1-30.4,1.8-32,1.9
  c-2-0.1-20-0.8-32.2-1.9c0,0-3.1-0.3-8.1-0.7V300H300z" />
            </svg>
          </div>
        </div>
      </div>

    </div>

    <div class="box">
      <div class="container">


        <div class="glass">
          <div class="pour"></div>
          <div class="fill"></div>
        </div>
      </div>

    </div>


  </div>

  <div class="tube-wrapper">
    <div class="tube"></div>

    <div class="play-section">
      <div class="wrapper clearfix" id="wrapper">
      </div>

    </div>
  </div>


  <script>
    const numberBottle = 9
    const colors = ["red", "orange", "yellow", "green", "blue", "violet", "white"]

    //shuffle
    function shuffle(array) {
      let currentIndex = array.length, randomIndex;

      // While there remain elements to shuffle...
      while (currentIndex != 0) {

        // Pick a remaining element...
        randomIndex = Math.floor(Math.random() * currentIndex);
        currentIndex--;

        // And swap it with the current element.
        [array[currentIndex], array[randomIndex]] = [
          array[randomIndex], array[currentIndex]];
      }

      return array;
    }

    //Fix value
    const bottle1 = [
      {
        value: 1,
        color: "red"
      },
      {
        value: 3,
        color: "orange"
      }
    ]

    const bottle2 = [
      {
        value: 1,
        color: "orange"
      },
      {
        value: 3,
        color: "red"
      }
    ]

    const bottle3 = [
      {
        value: 2,
        color: "yellow"
      },
      {
        value: 2,
        color: "green"
      }
    ]

    const bottle4 = [
      {
        value: 2,
        color: "green"
      }
    ]

    const bottle5 = [
      {
        value: 1,
        color: "blue"
      },
      {
        value: 2,
        color: "violet"
      },
      {
        value: 1,
        color: "white"
      }
    ]

    const bottle6 = [
      {
        value: 2,
        color: "white"
      },
      {
        value: 1,
        color: "blue"
      }
    ]

    const bottle7 = [
      {
        value: 1,
        color: "white"
      }
    ]

    const bottle8 = [
      {
        value: 2,
        color: "blue"
      },
      {
        value: 1,
        color: "violet"
      }
    ]

    const bottle9 = [
      {
        value: 1,
        color: "violet"
      },
      {
        value: 2,
        color: "yellow"
      }
    ]

    const bottles = [bottle1, bottle2, bottle3, bottle4, bottle5, bottle6, bottle7, bottle8, bottle9]

    //dom element
    const wrapper = document.getElementById('wrapper')
    let bottleArrayDisplay

    function render() {
      wrapper.innerHTML = "";
      bottleArrayDisplay = []
      for (let i = 0; i < numberBottle; i++) {
        const bottleCreate = document.createElement('div')
        const currentBottle = bottles[i]

        bottleCreate.classList.add("bottle-box")

        for (let j = 0; j < currentBottle.length; j++) {
          const floorCreate = document.createElement('div')
          floorCreate.classList.add("bottle-floor")
          floorCreate.style.backgroundColor = currentBottle[j].color;
          floorCreate.style.height = (currentBottle[j].value * 25) + "px";
          floorCreate.style.pointerEvents = "none"
          bottleCreate.appendChild(floorCreate)
        }

        bottleCreate.addEventListener("mousedown", e => {
          started(e, "mouse", i);
        });
        bottleCreate.addEventListener("touchstart", e => {
          started(e, "touch", i);
        });

        bottleArrayDisplay.push(bottleCreate)
        wrapper.appendChild(bottleArrayDisplay[i])
      }
    }

    let start,
      offsetX,
      offsetY,
      targetRect,
      target,
      dropped = false,
      action = false
    var currentTarget = { offsetLeft: 0, offsetTop: 0, index: 0, currentPositionX: 0, currentPositionY: 0, width: 25, height: 100 }

    const started = (e, type, index) => {
      target = e.target;
      //-------------------Cancel Start-------------------
      // Check bình rỗng hoặc bình đã hoàn thành
      if (bottles[index].length === 0 || (bottles[index][0].value === 4 && bottles[index][0].length === 1)) {
        return
      }
      start = true;

      if (type === "touch") {
        offsetX = e.touches[0].clientX - target.offsetLeft;
        offsetY = e.touches[0].clientY - target.offsetTop;
      } else {
        offsetX = e.clientX - target.offsetLeft;
        offsetY = e.clientY - target.offsetTop;
      }
      currentTarget.offsetLeft = target.offsetLeft
      currentTarget.offsetTop = target.offsetTop
      currentTarget.index = index
      currentTarget.currentPositionX = 0
      currentTarget.currentPositionY = 0
      currentTarget.width = target.offsetWidth
      currentTarget.height = target.offsetHeight
      targetRect = target.getBoundingClientRect();
      target.classList.add("is-selected");
      target.classList.remove("is-back")
      wrapper.classList.add("is-dragging");
    }

    const move = (e, type) => {
      e.preventDefault();
      let clientX = 0,
        clientY = 0;

      if (type === "touch") {
        clientX = e.touches[0].clientX;
        clientY = e.touches[0].clientY;
      } else {
        clientX = e.clientX;
        clientY = e.clientY;
      }
      if (start) {
        mousePosition = {
          x: clientX,
          y: clientY
        };
        target.style.left = (mousePosition.x - currentTarget.offsetLeft - offsetX) + 'px';
        target.style.top = (mousePosition.y - currentTarget.offsetTop - offsetY) + 'px';
        currentTarget.currentPositionX = (mousePosition.x - currentTarget.offsetLeft - offsetX)
        currentTarget.currentPositionY = (mousePosition.y - currentTarget.offsetTop - offsetY)
      }
    };

    const stopped = (e, type) => {
      start = false;
      currentTarget.currentPositionX = currentTarget.currentPositionX + currentTarget.offsetLeft
      currentTarget.currentPositionY = currentTarget.currentPositionY + currentTarget.offsetTop
      e.preventDefault();
      let clientX = 0,
        clientY = 0;

      if (type === "touch") {
        clientX = e.touches[0].clientX;
        clientY = e.touches[0].clientY;
      } else {
        clientX = e.clientX;
        clientY = e.clientY;
      }
      for (let i = 0; i < numberBottle; i++) {
        if (currentTarget.index != i) {
          let bottletBound = bottleArrayDisplay[i].getBoundingClientRect();
          if (currentTarget.currentPositionY > bottletBound.y - currentTarget.height &&
            currentTarget.currentPositionY < bottletBound.y + currentTarget.height &&
            currentTarget.currentPositionX > bottletBound.x - currentTarget.width &&
            currentTarget.currentPositionX < bottletBound.x + currentTarget.width) {
            //touched action
            // target.classList.add("is-action")
            // bottles[i][0].value = bottles[i][0].value + 1;
            // bottles[currentTarget.index][0].value = bottles[currentTarget.index][0].value - 1

            actionPouring(bottles[currentTarget.index], bottles[i])
            wrapper.classList.remove("is-dragging");
            render()
            return
          }
        }

      }

      //non-touched action
      actionBack(target)
    };


    wrapper.addEventListener("mouseup", (e) => {
      stopped(e, "mouse");
    });
    wrapper.addEventListener("touchend", (e) => {
      stopped(e, "touch");
    });

    wrapper.addEventListener("mousemove", e => {
      move(e, "mouse");
    });
    wrapper.addEventListener("touchmove", e => {
      move(e, "touch");
    });

    const actionPouring = (a, b) => {
      //-------------------Action-------------------
      // Khi bình 2 rỗng -> bình 2 nhận giá trị + xóa màu bên bình 1
      if (b.length === 0) {
        b.unshift(a[0])
        a.shift()
        return
      }

      let bSumValue = b.reduce((sum, ele) => {
        return sum + ele.value
      }, 0)
      let bRestValue = 4 - bSumValue
      //-------------------Cancel Action-------------------
      // Khi bình 2 đầy
      if (bSumValue >= 4) {
        actionBack(target)
        return
      }

      //-------------------Action-------------------
      // Khi khoảng trống của bình 2 lớn hơn hoặc bằng màu từ bình 1 đổ vào
      if (bRestValue >= a[0].value) {
        //trùng màu -> bình 2 nhận giá trị + xóa màu bên bình 1
        if (a[0].color === b[0].color) {
          b[0].value += a[0].value
          a.shift()
        } else {
          //khác màu -> bình 2 nhận màu + xóa màu bên bình 1
          b.unshift(a[0])
          a.shift()
        }
        return
      }
      // Khi khoảng trống của bình 2 nhỏ hơn màu từ bình 1 đổ vào
      if (bRestValue < a[0].value) {
        //trùng màu -> bình 2 nhận giá trị + bình 1 giảm giá trị
        if (a[0].color === b[0].color) {
          b[0].value += bRestValue
          a[0].value -= bRestValue
        } else {
          //khác màu -> bình 2 nhận màu + bình 1 giảm giá trị
          let valueExchange = {
            color: a[0].color,
            value: bRestValue
          }
          b.unshift(valueExchange)
          a[0].value -= bRestValue
        }
        return
      }
    }

    const actionBack = (target) => {
      target.classList.remove("is-selected");
      target.classList.add("is-back")
      target.style.left = 0;
      target.style.top = 0;
      wrapper.classList.remove("is-dragging");
    }

    render()
  </script>

</body>

</html>